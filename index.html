<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Website Builder</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Mobile View Critical Fixes */
        body {
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Syntax highlighting simple mock */
        #code-display {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
        }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
    </style>
</head>
<body class="font-sans antialiased">

    <div class="flex flex-1 w-full overflow-hidden">
        
        <aside class="w-64 bg-slate-900 border-r border-slate-700 flex flex-col flex-shrink-0 hidden md:flex transition-all duration-300" id="sidebar">
            <div class="p-4 border-b border-slate-700">
                <button onclick="createNewProject()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-lg shadow-blue-900/50">
                    <i class="fa-solid fa-plus"></i> New Project
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-2 space-y-2" id="project-list">
                </div>

            <div class="p-4 border-t border-slate-700 mt-auto">
                <button onclick="openSettings()" class="w-full flex items-center gap-3 text-slate-400 hover:text-white transition-colors p-2 rounded-md hover:bg-slate-800">
                    <i class="fa-solid fa-gear fa-lg"></i>
                    <span>Settings</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-800 relative">
            
            <header class="h-14 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-4 flex-shrink-0">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500 hover:bg-red-400 cursor-pointer"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500 hover:bg-yellow-400 cursor-pointer"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500 hover:bg-green-400 cursor-pointer"></div>
                </div>

                <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                    <button id="btn-preview" onclick="setView('preview')" class="px-3 py-1 text-xs font-medium rounded text-white bg-slate-700 shadow-sm transition-all">Preview</button>
                    <button id="btn-code" onclick="setView('code')" class="px-3 py-1 text-xs font-medium rounded text-slate-400 hover:text-white transition-all">Code</button>
                </div>

                <button onclick="downloadCode()" class="text-slate-400 hover:text-blue-400 transition-colors" title="Download HTML">
                    <i class="fa-solid fa-download"></i>
                </button>
                
                <button class="md:hidden text-slate-400" onclick="toggleSidebar()">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </header>

            <div class="flex-1 relative overflow-hidden bg-slate-100">
                <iframe id="preview-frame" class="w-full h-full bg-white absolute inset-0 z-10"></iframe>
                
                <div id="code-container" class="w-full h-full bg-slate-900 absolute inset-0 z-0 hidden overflow-auto p-4">
                    <pre><code id="code-display" class="text-green-400 text-sm"></code></pre>
                </div>

                <div id="loader" class="absolute inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center flex-col">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
                    <p class="text-white font-mono animate-pulse">Generating AI Code...</p>
                </div>
            </div>

            <footer class="bg-slate-900 border-t border-slate-700 p-4 flex-shrink-0 z-20">
                <form id="chat-form" onsubmit="handleDetailsSubmit(event)" class="relative max-w-4xl mx-auto flex gap-3">
                    <textarea 
                        id="user-input" 
                        class="w-full bg-slate-800 text-white border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none h-14"
                        placeholder="Describe your website... (e.g. 'A portfolio with a dark theme')"
                        required
                    ></textarea>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white rounded-xl px-6 flex items-center justify-center transition-colors flex-shrink-0">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </footer>

        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl transform transition-all" id="settings-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Settings</h2>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <form id="settings-form" onsubmit="saveSettings(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-uppercase text-slate-400 mb-1 tracking-wider">API URL</label>
                    <input type="text" id="setting-url" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-slate-300 focus:border-blue-500 outline-none" value="https://openrouter.ai/api/v1/chat/completions">
                </div>
                
                <div>
                    <label class="block text-xs font-uppercase text-slate-400 mb-1 tracking-wider">API Key (OpenRouter)</label>
                    <input type="password" id="setting-key" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-slate-300 focus:border-blue-500 outline-none" placeholder="sk-or-...">
                </div>

                <div>
                    <label class="block text-xs font-uppercase text-slate-400 mb-1 tracking-wider">Model ID</label>
                    <input type="text" id="setting-model" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-slate-300 focus:border-blue-500 outline-none" value="deepseek/deepseek-r1:free">
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded transition-colors">
                        Save Settings
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONSTANTS & STATE ---
        const SYSTEM_PROMPT = "You are an expert web developer. Output ONLY valid, complete HTML code (including internal CSS in <style> tags and basic JS in <script> tags if needed). Do NOT wrap in markdown backticks (```). Do NOT include explanations. Just the raw HTML code.";
        
        const DEFAULT_SETTINGS = {
            url: "[https://openrouter.ai/api/v1/chat/completions](https://openrouter.ai/api/v1/chat/completions)",
            key: "",
            model: "deepseek/deepseek-r1:free"
        };

        let currentProject = {
            id: Date.now(),
            name: "Untitled Project",
            code: ""
        };

        let projects = [];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadProjects();
            
            // If no projects, start fresh
            if (projects.length === 0) {
                projects.push(currentProject);
                saveProjects();
            } else {
                currentProject = projects[0];
            }
            
            updateUI();
        });

        // --- API LOGIC (CRITICAL FIXES IMPLEMENTED) ---
        async function callAI(prompt) {
            const settings = getSettings();
            
            if (!settings.key) {
                alert("Please enter your API Key in Settings (Gear Icon).");
                openSettings();
                return null;
            }

            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');

            try {
                const response = await fetch(settings.url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${settings.key}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href, // OpenRouter requirement
                        'X-Title': 'AI Website Builder' // OpenRouter requirement
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: `Create a website based on this request: ${prompt}. Remember: ONLY output raw HTML.` }
                        ]
                    })
                });

                // CRITICAL FIX 2: Anti-Crash Logic
                const text = await response.text();
                
                if (!response.ok) {
                    alert(`API Error (${response.status}): ${text}`);
                    throw new Error(`API Error: ${text}`);
                }

                const data = JSON.parse(text);
                
                // Handle different response structures just in case, but target standard OpenAI format
                let content = data.choices?.[0]?.message?.content || "";

                // Cleanup: Remove markdown blocks if the model ignored instructions
                content = content.replace(/```html/g, '').replace(/```/g, '');
                
                return content;

            } catch (error) {
                console.error(error);
                return null;
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function handleDetailsSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const prompt = input.value.trim();
            
            if (!prompt) return;

            const code = await callAI(prompt);
            
            if (code) {
                currentProject.code = code;
                // Generate a name based on first few words if it's untitled
                if(currentProject.name === "Untitled Project") {
                    currentProject.name = prompt.substring(0, 20) + "...";
                }
                saveProjects();
                updateUI();
            }
            
            input.value = "";
        }

        // --- UI & STATE MANAGEMENT ---

        function updateUI() {
            // Update Preview
            const frame = document.getElementById('preview-frame');
            frame.srcdoc = currentProject.code;
            
            // Update Code View
            document.getElementById('code-display').textContent = currentProject.code;
            
            // Update Project List
            renderProjectList();
        }

        function setView(view) {
            const previewFrame = document.getElementById('preview-frame');
            const codeContainer = document.getElementById('code-container');
            const btnPreview = document.getElementById('btn-preview');
            const btnCode = document.getElementById('btn-code');

            if (view === 'preview') {
                previewFrame.classList.remove('hidden');
                previewFrame.classList.add('z-10');
                codeContainer.classList.add('hidden');
                codeContainer.classList.remove('z-10');
                
                btnPreview.className = "px-3 py-1 text-xs font-medium rounded text-white bg-slate-700 shadow-sm transition-all";
                btnCode.className = "px-3 py-1 text-xs font-medium rounded text-slate-400 hover:text-white transition-all";
            } else {
                previewFrame.classList.add('hidden');
                previewFrame.classList.remove('z-10');
                codeContainer.classList.remove('hidden');
                codeContainer.classList.add('z-10');
                
                btnCode.className = "px-3 py-1 text-xs font-medium rounded text-white bg-slate-700 shadow-sm transition-all";
                btnPreview.className = "px-3 py-1 text-xs font-medium rounded text-slate-400 hover:text-white transition-all";
            }
        }

        // --- PROJECT MANAGEMENT ---

        function createNewProject() {
            currentProject = {
                id: Date.now(),
                name: "Untitled Project",
                code: ""
            };
            projects.unshift(currentProject);
            saveProjects();
            updateUI();
        }

        function loadProjects() {
            const stored = localStorage.getItem('ai_builder_projects');
            if (stored) {
                projects = JSON.parse(stored);
            }
        }

        function saveProjects() {
            // Update current project in array
            const index = projects.findIndex(p => p.id === currentProject.id);
            if (index !== -1) {
                projects[index] = currentProject;
            } else {
                projects.unshift(currentProject);
            }
            localStorage.setItem('ai_builder_projects', JSON.stringify(projects));
        }

        function loadProject(id) {
            const project = projects.find(p => p.id === id);
            if (project) {
                currentProject = project;
                updateUI();
                // Close sidebar on mobile after selection
                const sidebar = document.getElementById('sidebar');
                if(!sidebar.classList.contains('hidden') && window.innerWidth < 768) {
                    sidebar.classList.add('hidden');
                }
            }
        }

        function renderProjectList() {
            const list = document.getElementById('project-list');
            list.innerHTML = '';
            
            projects.forEach(p => {
                const isActive = p.id === currentProject.id;
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer transition-colors truncate ${isActive ? 'bg-slate-800 text-white border-l-4 border-blue-500' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`;
                div.textContent = p.name;
                div.onclick = () => loadProject(p.id);
                
                // Add delete button (mini feature)
                if (projects.length > 1) {
                     // Simple implementation could go here, omitting for strict adherence to prompt simplicity
                }
                
                list.appendChild(div);
            });
        }

        function downloadCode() {
            const blob = new Blob([currentProject.code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- SETTINGS MANAGEMENT ---

        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            loadSettingsInputs();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings(e) {
            e.preventDefault();
            const settings = {
                url: document.getElementById('setting-url').value,
                key: document.getElementById('setting-key').value,
                model: document.getElementById('setting-model').value
            };
            localStorage.setItem('ai_builder_settings', JSON.stringify(settings));
            closeSettings();
        }

        function getSettings() {
            const stored = localStorage.getItem('ai_builder_settings');
            return stored ? JSON.parse(stored) : DEFAULT_SETTINGS;
        }

        function loadSettings() {
            // Check if settings exist, if not set defaults
            if (!localStorage.getItem('ai_builder_settings')) {
                localStorage.setItem('ai_builder_settings', JSON.stringify(DEFAULT_SETTINGS));
            }
        }

        function loadSettingsInputs() {
            const settings = getSettings();
            document.getElementById('setting-url').value = settings.url;
            document.getElementById('setting-key').value = settings.key;
            document.getElementById('setting-model').value = settings.model;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
            // If showing, make it absolute on mobile to cover
            if (!sidebar.classList.contains('hidden')) {
                sidebar.classList.add('absolute', 'z-40', 'h-full');
            } else {
                sidebar.classList.remove('absolute', 'z-40', 'h-full');
            }
        }
    </script>
</body>
  </html>
    
